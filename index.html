<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Retrocards</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="intro-banner">
    <h2>Upload a photo. Pick your world. Customize your alter ego.</h2>
    <p>Retrocards combines you with the raw essence of your favorite retro characters.</p>
  </header>

  <div class="container">
    <h1>Retrocards</h1>
    <form id="customizer-form">
      <label for="imageUpload">Upload Your Photo</label>
      <input type="file" id="imageUpload" accept="image/*" />
      <div id="preview"></div>

      <div id="spinner" style="display: none; text-align: center; margin-top: 1rem;">
        <p>Generating image...</p>
        <div class="loader"></div>
      </div>

      <label>Select Your Character Style</label>
      <div class="template-options">
        <div class="template" data-character="Grendals">
          <img src="templates/grendals-thumb.png.jfif" alt="Grendals" />
          <p>Grendals</p>
          <small class="template-desc">Don't get them wet. Don't expose them to phone light. Don't feed them after midnight.</small>
        </div>
        <div class="template" data-character="Operation Bravo">
          <img src="templates/operation-bravo-thumb.png.PNG" alt="Operation Bravo" />
          <p>Operation Bravo</p>
          <small class="template-desc">Put the action back in action hero!</small>
        </div>
        <div class="template" data-character="Trash Can Kids">
          <img src="templates/slop-squad-thumb.png.png" alt="Trash Can Kids" />
          <p>Trash Can Kids</p>
          <small class="template-desc">Disgustingly Disturbing</small>
        </div>
      </div>

      <div id="custom-inputs" class="custom-inputs hidden">
        <div class="input-block" id="block-dominantTrait">
          <label for="dominantTrait">Dominant Trait (for Grendals)</label>
          <input type="text" id="dominantTrait" placeholder="e.g. slimy" />
        </div>

        <div class="input-block" id="block-visualStyle">
          <label for="visualStyle">Visual Style (for Grendals)</label>
          <input type="text" id="visualStyle" placeholder="e.g. toxic punk" />
        </div>

        <div class="input-block" id="block-weaponType">
          <label for="weaponType">Weapon Type (for Operation Bravo)</label>
          <input type="text" id="weaponType" placeholder="e.g. tactical rifle" />
        </div>

        <div class="input-block" id="block-combatStyle">
          <label for="combatStyle">Combat Style (for Operation Bravo)</label>
          <input type="text" id="combatStyle" placeholder="e.g. close quarters" />
        </div>

        <div class="input-block" id="block-favoriteItem">
          <label for="favoriteItem">Favorite Item (for Trash Can Kids)</label>
          <input type="text" id="favoriteItem" placeholder="e.g. moldy lunchbox" />
        </div>

        <div class="input-block" id="block-favoriteActivity">
          <label for="favoriteActivity">Favorite Activity (for Trash Can Kids)</label>
          <input type="text" id="favoriteActivity" placeholder="e.g. burping contests" />
        </div>
      </div>

      <button type="submit">Generate Character</button>
    </form>

    <div id="download-wrapper" style="text-align:center; margin-top: 1rem;"></div>
  </div>

  <script>
    document.getElementById("imageUpload").addEventListener("change", function () {
      const preview = document.getElementById("preview");
      preview.innerHTML = "";
      const file = this.files[0];

      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const img = document.createElement("img");
          img.src = e.target.result;
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      }
    });

    document.querySelectorAll(".template").forEach((template) => {
      template.addEventListener("click", function () {
        document.querySelectorAll(".template").forEach((el) => el.classList.remove("selected"));
        this.classList.add("selected");

        const selectedChar = this.dataset.character;
        const inputBlock = document.getElementById("custom-inputs");
        inputBlock.classList.remove("hidden");

        const allBlocks = document.querySelectorAll(".input-block");
        allBlocks.forEach(block => block.style.display = "none");

        if (selectedChar === "Grendals") {
          ["dominantTrait", "visualStyle"].forEach(id => {
            document.getElementById("block-" + id).style.display = "block";
          });
        } else if (selectedChar === "Operation Bravo") {
          ["weaponType", "combatStyle"].forEach(id => {
            document.getElementById("block-" + id).style.display = "block";
          });
        } else if (selectedChar === "Trash Can Kids") {
          ["favoriteItem", "favoriteActivity"].forEach(id => {
            document.getElementById("block-" + id).style.display = "block";
          });
        }
      });
    });

    document.getElementById("customizer-form").addEventListener("submit", async function (e) {
      e.preventDefault();

      const selected = document.querySelector(".template.selected");
      const uploadedFile = document.getElementById("imageUpload").files[0];
      const spinner = document.getElementById("spinner");
      const preview = document.getElementById("preview");
      const download = document.getElementById("download-wrapper");

      if (!selected || !uploadedFile) {
        alert("Please upload a photo and select a character template.");
        return;
      }

      const formData = new FormData();
      formData.append("photo", uploadedFile);
      formData.append("character", selected.dataset.character);

      ["dominantTrait", "visualStyle", "weaponType", "combatStyle", "favoriteItem", "favoriteActivity"].forEach(id => {
        const el = document.getElementById(id);
        if (el && el.value.trim()) {
          formData.append(id, el.value.trim());
        }
      });

      spinner.style.display = "block";
      preview.innerHTML = "";
      download.innerHTML = "";

      try {
        const response = await fetch("https://retrocardtest.onrender.com/generate", {
          method: "POST",
          body: formData,
        });

        const data = await response.json();
        spinner.style.display = "none";

        if (data.imageUrl) {
          preview.innerHTML = `<img src="${data.imageUrl}" alt="Generated Image" id="generatedImage" />`;

          download.innerHTML = `
            <a href="${data.imageUrl}" download="retrocards-image.png">
              <button type="button" class="download-button">Download Image</button>
            </a>
          `;
        } else {
          alert("Image generation failed. Please try again.");
        }
      } catch (err) {
        spinner.style.display = "none";
        console.error("Error:", err);
        alert("An error occurred while generating the image.");
      }
    });
  </script>
</body>
</html>
